
@{
    ViewBag.Title = "ManagerRouter";
    Layout = "~/Views/Shared/_OffLayout.cshtml";
    ViewBag.Current = "headingSix";
}
<h2>ManagerRouter</h2>
<style>
    .wrap{
        margin-top:20px;
    }
    .staff-content{
        margin-top:20px;
    }
    .staff-info{
        height:auto;
        border:1px solid #ccc;
    }
    .event-tab{
        padding:10px;
    }
    .map-box{
        height:400px;
        border:1px solid #ccc;
    }
    #modal-time{
        float:right;
    }
    #modal-content{
        padding-top:10px;
    }
    .carousel-inner{
        text-align:center;
    }
    .carousel-inner .item img{
        display:inline;
        width:50%;
    }
    #myModal{
        left:0;
        right:0;
        margin:0 auto;
    }
</style>
<div class="wrap">
    <div class="container">
        <form class="form-inline" role="form">
            <div class="form-group">
                <label for="input-staffname">职员姓名：</label>
            </div>
            <div class="form-group">
                @Html.DropDownList("input-staffname", ViewBag.ManagerList as SelectList, new { @class= "form-control" })
            </div>
            <div class="form-group">
                <label for="input-date">日期：</label>
            </div>
            <div class="form-group">
                <input class="form-control" id="input-date">
            </div>
            <button type="button" class="btn btn-default" id="btn-100">查询</button>
        </form>
        <div class="staff-content">
            <div class="row">
                <div class="col-md-7 map-box" id="allmap">
                </div>
                <div class="col-md-3 staff-info">              
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active" id="complete"><a href="javascript:;">工作重点</a></li>
                        <li role="presentation" id="uncomplete"><a href="javascript:;">日常工作</a></li>
                        <li role="presentation" id="assistance"><a href="javascript:;">问题</a></li>
                    </ul>
                    <div id="event-complete" class="event-tab"></div>
                    <div id="event-uncomplete" class="event-tab2 event-tab"></div>
                    <div id="event-assistance" class="event-tab2 event-tab"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <a href="javascript:;" type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></a>
                <h4 class="modal-title">查看图片<span id="modal-time"></span></h4>
                <h5 id="modal-content"></h5>
            </div>
            <div class="modal-body" id="router-info">
                <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                    <!-- Indicators -->
                    <ol class="carousel-indicators">
                    </ol>
                    <!-- Wrapper for slides -->
                    <div class="carousel-inner" role="listbox">
                        <div class="item active">
                        </div>
                    </div>
                    <!-- Controls -->
                    <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
                        <span class="glyphicon glyphicon-chevron-left"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
                        <span class="glyphicon glyphicon-chevron-right"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=XVa3iy9AFIZBX9QQApmHonEG"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $("#btn-100").click(function () {
            $.ajax({
                url: "/OffManager/ManagerRouterDetails",
                dataType: "json",
                data:{
                    username: $("#input-staffname").val(),
                    date: $("#input-date").val()
                },
                success: function (data) {
                    if (data.result == "FAIL") {
                        alert("此员工在" + $("#input-date").val() + "无活动记录");
                        $("#allmap").html("");
                        $(".staff-info div").html("");
                    } else {
                        createmap(data);
                        createsummary(data);
                    }
                },
                error: function (xhr) {
                    alert(xhr.status);
                }
            });
        });
    $("#input-date").datepicker({ dateFormat: 'yy-mm-dd' }); //创建日期列表
    // 百度地图API功能
    function createmap(data) {
        var map = new BMap.Map("allmap");
        var point_mark = data.router[0].Location.toString().split(',');
        var point = new BMap.Point(point_mark[0], point_mark[1]);
        var top_left_control = new BMap.ScaleControl({ anchor: BMAP_ANCHOR_TOP_LEFT });// 左上角，添加比例尺
        var top_left_navigation = new BMap.NavigationControl();  //左上角，添加默认缩放平移控件
        add_control();
            map.centerAndZoom(point, 11);
            map.enableScrollWheelZoom(true);
            map.disableDragging();     //禁止拖拽
            setTimeout(function () {
                map.enableDragging();   //两秒后开启拖拽
                map.enableInertialDragging();   //两秒后开启惯性拖拽
            }, 2000);
            var startIcon = new BMap.Icon("/Content/images/mark_1.png", new BMap.Size(20, 25),{
                anchor: new BMap.Size(10, 25)
            });//开始图片
            var endIcon = new BMap.Icon("/Content/images/mark_6.png", new BMap.Size(20, 25),{
                anchor: new BMap.Size(10, 25)
            });//结束图片
            var mymarker = [];
            for (var i = 0; i < data.router.length; i++) {
                var temp_mark = data.router[i].Location.toString().split(',');
                if (i == 0) {
                    var marker = new BMap.Marker(new BMap.Point(temp_mark[0], temp_mark[1]), {icon:startIcon});
                    mymarker[i] = new BMap.Point(temp_mark[0], temp_mark[1]);
                    map.addOverlay(marker);   //增加点
                    var content = data.router[i].Remark; //创建文本
                    addClickHandler(content, marker, data.router[i].Photo, data.router[i].CheckIn_Time, data.router[i].Id);  //增加文本

                }
                else {
                    var marker = new BMap.Marker(new BMap.Point(temp_mark[0], temp_mark[1]));
                    mymarker[i] = new BMap.Point(temp_mark[0], temp_mark[1]);
                    map.addOverlay(marker);   //增加点
                    var content = data.router[i].Remark; //创建文本
                    addClickHandler(content, marker, data.router[i].Photo, data.router[i].CheckIn_Time, data.router[i].Id);  //增加文本
                }
            }
            translateCallback = function (dat) {
                console.log(dat);
                if (dat.status === 0) {
                    console.log(data.mymarker);
                    for (var i = 0; i < data.mymarker.length; i++) {
                        bm.addOverlay(new BMap.Marker(data.mymarker[i]));
                        bm.setCenter(data.mymarker[i]);
                    }
                }
            }
            setTimeout(function () {
                var convertor = new BMap.Convertor();
                convertor.translate(mymarker, 1, 5, translateCallback)
            }, 1000);
            var polyline = new BMap.Polyline(mymarker, { strokeColor: "blue", strokeWeight: 2, strokeOpacity: 1 });   //创建折线
            map.addOverlay(polyline);//增加折线
            function add_control() {
                map.addControl(top_left_control);
                map.addControl(top_left_navigation);
            }
            function addMarker(point, label) {
                map.addOverlay(marker);
                marker.setLabel(label);
            }
            function addClickHandler(content, marker, photo, time, id) {
                marker.addEventListener("click", function (e) {
                    // 添加代码
                    $("#modal-time").html("时间：" + time);
                    $("#modal-content").html("门店地址：" + content);
                    $("#carousel-example-generic .carousel-indicators").html("");
                    $("#carousel-example-generic .carousel-inner").html("");
                    var photolist = photo.split(',');
                    for (var i = 0; i < photolist.length; i++) {
                        if (i != 0) {
                            $("#carousel-example-generic .carousel-indicators").append("<li data-target=\"#carousel-example-generic\" data-slide-to=\"" + i + "\"></li>");
                            $("#carousel-example-generic .carousel-inner").append("<div class=\"item\"><img src=\"https://cdn2.shouquanzhai.cn/checkin-img/" + photolist[i] + "\"></div>");
                        }
                        else {
                            $("#carousel-example-generic .carousel-indicators").append("<li data-target=\"#carousel-example-generic\" data-slide-to=\"" + i + "\" class=\"active\"></li>");
                            $("#carousel-example-generic .carousel-inner").append("<div class=\"item active\"><img src=\"https://cdn2.shouquanzhai.cn/checkin-img/" + photolist[i] + "\"></div>");
                        }
                    }
                    $('.carousel').carousel();
                    $("#myModal").modal();
                });
            }     
        }
    });
    //创建个人信息和切换
    function createsummary(data) {
        $(".nav-tabs").show();
        var nav = $(".nav-tabs").find("li");
        nav.each(function () {
            $("#event-complete").html(data.summary.Event_Complete);
            $("#event-uncomplete").html(data.summary.Event_UnComplete);
            $("#event-assistance").html(data.summary.Event_Assistance);
            $(".event-tab2").hide();
            $(this).click(function () {
                nav.removeClass("active");
                $(this).addClass("active");
                var li_id = $(this).attr("id");
                var div_id = "#event\-" + li_id;
                $(".event-tab").hide();
                $(div_id).show();
            })
        })
    }
</script>


