
@{
    ViewBag.Title = "Visit_View";
    Layout = "~/Views/Shared/_VisitManagementView.cshtml";
}
<div>
    <div id="shared_select_condition" style="padding:0 20px">
        <div class="select_condition_div">
            <label class="pull-left">销售团队：</label>
            <ul class="shared_ul visitor_ul">
                <li class="shared_section_li_active" style="margin-left: 12px">
                    <a class="team_select active" data-val="2">王者队</a>
                </li>
                <li>
                    <a class="team_select" data-val="5">飞龙队</a>
                </li>
            </ul>
        </div>
        <div class="select_condition_div">
            <label class="pull-left">公司类型：</label>
            <ul class="shared_ul company_ul">
                <li class="shared_section_li_active" style="margin-left: 12px">
                    <a class="company_type active" data-val="1">现代渠道</a>
                </li>
                <li>
                    <a class="company_type" data-val="2">流通</a>
                </li>
                <li>
                    <a class="company_type" data-val="3">电商和APP</a>
                </li>
            </ul>
        </div>
        <div class="select_condition_div">
            <label class="pull-left">拜访日期：</label>
            <div class="select_condition_div2">
                <input type="text" class="file-date shared_view_date" id="select_date" value="@DateTime.Now.ToString("yyyy-MM-dd")" readonly="readonly" autocomplete="off" name="file-date" placeholder="选择日期" style="margin-left: 12px;cursor: default;" />
                <b class="arrows_view"></b>
            </div>
        </div>
        <div class="select_condition_div">
            <label class="pull-left">公司名称：</label>
            <div class="select_condition_div2">
                <div type="text" class="shared_view_div" id="company_id" style="margin-left: 12px;">
                    <span class="shared_view_span company_view_span" data-name="">请选择公司</span>
                    <b class="glass_view background_view"></b>
                    <div class="hidden_div hidden">
                        <input class="company_search_input search_input" />
                        <select class="select_view" size="4">
                            @foreach (var name in ViewBag.Company)
                            {
                                <option>@name.Company_Name</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="select_condition_div">
            <label class="pull-left">业务员名称：</label>
            <div class="select_condition_div2">
                <div type="text" class="shared_view_div" id="visitor_id" style="top:2px">
                    <span class="shared_view_span visitor_view_span" data-name="">请选择业务员</span>
                    <b class="glass_view background_view"></b>
                    <div class="hidden_div hidden">
                        <div class="search_contain_div">
                            <input class="visitor_search_input search_input"/>
                            <b class="search_icon"></b>
                        </div>
                        <select class="select_view" size="4">
                            @foreach (var name in ViewBag.Visitor)
                            {
                                <option>@name.Employee_Name</option>
                            }
                        </select>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="visit_list_content"></div>
</div>
@section scripts{
    <script>
        $(function () {
            // 获取时间
            //function getNowFormatDate() {
            //    var date = new Date();
            //    var seperator1 = "-";
            //    var seperator2 = ":";
            //    var month = date.getMonth() + 1;
            //    var strDate = date.getDate();
            //    if (month >= 1 && month <= 9) {
            //        month = "0" + month;
            //    }
            //    if (strDate >= 0 && strDate <= 9) {
            //        strDate = "0" + strDate;
            //    }
            //    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
            //    return currentdate;
            //}
            //$("#select_date").val(getNowFormatDate())
            $.ajax({
                url: "/VisitManagement/Visit_PartialView/",
                type: "post",
                data: {
                    visit_date: $("#select_date").val(),
                    dep_id: $(".team_select.active").attr("data-val"),
                    com_type: $(".company_type.active").text(),
                    com_name: $("#company_id .shared_view_span").attr("data-name"),
                    vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                },
                success: function (data) {
                    $("#visit_list_content").html(data)
                }
            })
            // 日期
            $("#select_date").change(function () {
                var that = $(this)
                $.ajax({
                    url: "/VisitManagement/Visit_PartialView/",
                    type: "post",
                    data: {
                        visit_date: that.val(),
                        dep_id: $(".team_select.active").attr("data-val"),
                        com_type: $(".company_type.active").text(),
                        com_name: $("#company_id .shared_view_span").attr("data-name"),
                        vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                    },
                    success: function (data) {
                        $("#visit_list_content").html(data)
                    }
                })
            })
            // 团队
            $(".team_select").on("click", function () {
                var that = $(this)
                $(".visitor_ul li").removeClass("shared_section_li_active")
                $(".team_select").removeClass("active")
                that.parent("li").addClass("shared_section_li_active")
                that.addClass("active")
                $.ajax({
                    url: "/VisitManagement/Visit_PartialView/",
                    type: "post",
                    data: {
                        visit_date: $("#select_date").val(),
                        dep_id: that.attr("data-val"),
                        com_type: $(".company_type.active").text(),
                        com_name: $("#company_id .shared_view_span").attr("data-name"),
                        vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                    },
                    success: function (data) {
                        $("#visit_list_content").html(data)
                    }
                })
            })
            // 公司
            $(".company_type").on("click", function () {
                var that = $(this)
                $(".company_ul li").removeClass("shared_section_li_active")
                $(".company_type").removeClass("active")
                that.parent("li").addClass("shared_section_li_active")
                that.addClass("active")
                $.ajax({
                    url: "/VisitManagement/Visit_PartialView/",
                    type: "post",
                    data: {
                        visit_date: $("#select_date").val(),
                        dep_id: $(".team_select.active").attr("data-val"),
                        com_type: that.text(),
                        com_name: $("#company_id .shared_view_span").attr("data-name"),
                        vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                    },
                    success: function (data) {
                        $("#visit_list_content").html(data)
                    }
                })
            })
            // span 点击
            $(".shared_view_div").on("click", function (event) {
                event.stopPropagation();
                var that = $(this)
                $(".hidden_div").addClass("hidden")
                $(".shared_view_div").removeClass("shared_view_span_active")
                that.addClass("shared_view_span_active")
                that.children(".hidden_div").removeClass("hidden")
                that.children(".background_view").removeClass("glass_view").addClass("glass_view_active")
            })
            // 隐藏的选择列表弹出、隐藏
            $(document).on('click', function () {
                $(".hidden_div").addClass("hidden");
                $(".background_view").removeClass("glass_view_active").addClass("glass_view")
                $(".search_input").val("")
                $(".shared_view_div ").removeClass("shared_view_span_active")
            });
            $("#visitor_id .select_view").click(function (event) {
                event.stopPropagation();
                var options = $("#visitor_id .select_view option:selected")
                $(this).parents(".hidden_div").addClass("hidden").siblings(".visitor_view_span").html(options.text()).attr("data-name", options.text())
                //$(this).parents(".shared_view_div").css("top", "1px")
                $(".background_view").removeClass("glass_view_active").addClass("glass_view")
                $.ajax({
                    url: "/VisitManagement/Visit_PartialView/",
                    type: "post",
                    data: {
                        visit_date: $("#select_date").val(),
                        dep_id: $(".team_select.active").attr("data-val"),
                        com_type: $(".company_type.active").text(),
                        com_name: $("#company_id .shared_view_span").attr("data-name"),
                        vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                    },
                    success: function (data) {
                        $("#visit_list_content").html(data)
                    }
                })
            })
            $("#company_id .select_view").click(function (event) {
                event.stopPropagation();
                var options = $("#company_id .select_view option:selected")
                $(this).parents(".hidden_div").addClass("hidden").siblings(".company_view_span").html(options.text()).attr("data-name", options.text())
                //$(this).parents(".shared_view_div").css("top", "1px")
                $(".background_view").removeClass("glass_view_active").addClass("glass_view")
                $.ajax({
                    url: "/VisitManagement/Visit_PartialView/",
                    type: "post",
                    data: {
                        visit_date: $("#select_date").val(),
                        dep_id: $(".team_select.active").attr("data-val"),
                        com_type: $(".company_type.active").text(),
                        com_name: $("#company_id .shared_view_span").attr("data-name"),
                        vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                    },
                    success: function (data) {
                        $("#visit_list_content").html(data)
                    }
                })
            })
            // 搜索
            // visitor
            $(".visitor_search_input").on("input", function () {
                if ($(".visitor_search_input").val() == "") {
                    $("#visitor_id select").removeClass("hidden")
                }
                else {
                    $('.visitor_search_input').typeahead({
                        ajax: {
                            url: '/VisitManagement/QueryVisitor',
                            triggerLength: 1
                        },
                        itemSelected: displayResult,
                        display: 'VisitorName',
                        val: 'Id'
                    });
                    function displayResult(item, val, text) {
                        $(".visitor_view_span").text(text).attr("data-name", text);
                        $("#visitor_id .hidden_div").addClass("hidden")
                        $(".background_view").removeClass("glass_view_active").addClass("glass_view")
                        $(".visitor_search_input").val("")
                        $("#visitor_id select").removeClass("hidden")
                        $.ajax({
                            url: "/VisitManagement/Visit_PartialView/",
                            type: "post",
                            data: {
                                visit_date: $("#select_date").val(),
                                dep_id: $(".team_select.active").attr("data-val"),
                                com_type: $(".company_type.active").text(),
                                com_name: $("#company_id .shared_view_span").attr("data-name"),
                                vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                            },
                            success: function (data) {
                                $("#visit_list_content").html(data)
                            }
                        })
                    }
                    $("#visitor_id select").addClass("hidden")
                }
            });
            //company
            $(".company_search_input").on("input", function () {
                if ($(".company_search_input").val()=="") {
                    $("#company_id select").removeClass("hidden")
                } else {

                    $('.company_search_input').typeahead({
                        ajax: {
                            url: '/VisitManagement/QueryCompany',
                            triggerLength: 1
                        },
                        itemSelected: displayCResult,
                        display: 'CompanyName',
                        val: 'Id'
                    });
                    function displayCResult(item, val, text) {
                        $(".company_view_span").text(text).attr("data-name", text);
                        $("#company_id .hidden_div").addClass("hidden")
                        $(".background_view").removeClass("glass_view_active").addClass("glass_view")
                        $(".company_search_input").val("")
                        $("#company_id select").removeClass("hidden")
                        $.ajax({
                            url: "/VisitManagement/Visit_PartialView/",
                            type: "post",
                            data: {
                                visit_date: $("#select_date").val(),
                                dep_id: $(".team_select.active").attr("data-val"),
                                com_type: $(".company_type.active").text(),
                                com_name: $("#company_id .shared_view_span").attr("data-name"),
                                vis_name: $("#visitor_id .shared_view_span").attr("data-name")
                            },
                            success: function (data) {
                                $("#visit_list_content").html(data)
                            }
                        })
                    }
                    $("#company_id select").addClass("hidden")
                }
            })
        })
    </script>
    }