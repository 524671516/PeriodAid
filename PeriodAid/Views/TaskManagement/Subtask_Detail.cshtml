@model PeriodAid.Models.SubTask
<div class="modal-header" id="modal-header-assignment" data-aid="@Model.Id">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <a class="close dropdown-toggle" aria-haspopup="true" aria-expanded="false" data-toggle="dropdown" href="#">更多<i class="fa fa-caret-down color-blue" aria-hidden="true" title="更多"></i></a>
    <h4 class="modal-title" id="Edit-SubtaskLabel">
        <a href="javascript:;" class="color-blue tm-show-task-modal"  data-aid="@Model.AssignmentId">@Html.Encode(Model.Assignment.AssignmentTitle)</a>
    <span class="color-gray">/@Html.Encode(Model.TaskTitle)</span>
    </h4>
    <div class="dropdown-menu tm_dropdown tm_dropdown_width">
        <ul>
            <li class="text-center"><strong class="color-blue">更多功能</strong></li>
            <li role="separator" class="divider"></li>
        </ul>
        <ul class="tm_dropdown_list">
            <li><a href="javascript:;" id="btn_del_subtask" data-stid="@Model.Id"><span class="color-red">删除任务</span></a></li>
        </ul>
    </div>
</div>
<div class="modal-body">
    @using (Html.BeginForm("EditSubtask", "TaskManagement", FormMethod.Post, new { @id = "edit_subtask_form", @class = "validate-form" }))
    {
        @Html.AntiForgeryToken()
        @Html.ValidationSummary()
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.CreateTime)
        @Html.HiddenFor(m => m.Status)
        @Html.HiddenFor(m=>m.AssignmentId)
        <div class="form-group">
            <label for="AssignmentTitle">任务名称</label>
            @Html.TextBoxFor(m => m.TaskTitle, new { @class = "form-control", @placeholder = "任务名称" })
        </div>
        <div class="form-group">
            <label for="Remarks">任务描述</label>
            @Html.TextAreaFor(m => m.Remarks, new { @class = "form-control", @rows = "3", @placeholder = "任务描述" })
        </div>
        <div class="row">
            <div class="form-group col-md-6 input-append date">
                <label for="RemindDate">提醒时间</label>
                @if (Convert.ToDateTime(Model.RemindDate).ToString("yyyy-MM-dd") == "0001-01-01")
                {
                    <input id="RemindDate" name="RemindDate" type="text" readonly class="form-control form_datetime" />
                }
                else
                {
                    <input id="RemindDate" name="RemindDate" type="text" readonly class="form-control form_datetime" value="@Convert.ToDateTime(Model.RemindDate).ToString("yyyy-MM-dd HH:00")" />
                }

            </div>
            <div class="form-group col-md-6 input-append date">
                <label for="Deadline">截止期限</label>
                @if (Convert.ToDateTime(Model.Deadline).ToString("yyyy-MM-dd") == "0001-01-01")
                {
                    <input id="Deadline" name="Deadline" type="text" readonly class="form-control form_datetime" />
                }
                else
                {
                    <input id="Deadline" name="Deadline" type="text" readonly class="form-control form_datetime" value="@Convert.ToDateTime(Model.Deadline).ToString("yyyy-MM-dd HH:00")" />
                }
            </div>
        </div>
        <div class="row">
            <div class="form-group col-md-6">
                <label for="ExecutorId">执行人</label>
                @Html.DropDownListFor(m => m.ExecutorId, ViewBag.EmployeeDropDown as SelectList, new { @class = "form-control selectpicker dropdowm", @id = "tm_select_straff" })
            </div>
            <div class="form-group col-md-6">
                <label for="AssignmentId">关联任务</label>
                <div class="form-control disabled">@Html.Encode(Model.Assignment.AssignmentTitle)</div>
                
            </div>
        </div>
    }
    <!--Collaborator Area End-->
</div>
<div class="modal-footer">
    <button type="button" class="btn btn-primary" id="btn_edit_subtask">保存</button>
</div>
<script type="text/javascript">
    //初始化选择插件
    $('#tm_select_straff').selectpicker({
        liveSearch: true,
        liveSearchPlaceholder: "搜索人员",
        width: "100%",
        dropupAuto: false,
    });
    //日期插件初始化
    CompleteTimeWidget(".form_datetime");
    //修改任务验证
    $("#edit_subtask_form").validate({
        debug: false,
        rules: {
            TaskTitle: {
                required: true,
                maxlength: 128
            }
        },
        //验证通过的正式提交函数
        submitHandler: function (form) {
            $(form).ajaxSubmit(function (data) {
                if (data.result == "SUCCESS") {
                    UnimportantAlert("子任务修改成功");
                    $("#btn_edit_subtask").removeClass("disabled");
                    $('#Edit-Assignment').modal('hide');
                } else {
                    ErrorAlert(data.errmsg);
                    $("#btn_edit_subtask").removeClass("disabled");
                }
            })
        },
        errorClass: "has-error",
        //验证失败
        errorPlacement: function (error, element) {
            $("#btn_edit_subtask").removeClass("disabled");
        }
    });
    //修改任务的提交
    $("#btn_edit_subtask").on("click", function () {
        if (!$(this).hasClass("disabled")) {
            $(this).addClass("disabled")
            $("#edit_subtask_form").submit();
        }
    });
    //删除子任务
    $("#btn_del_subtask").on("click", function () {
        var that = $(this);
        CustomConfirm("删除此任务将不可恢复，请确认是否删除?", function () {
            var _data = {
                SubTaskId: that.attr("data-stid")
            }
            EditForAjax("/TaskManagement/Delete_Subtask", _data, function (data) {
                //成功
                var __data = {
                    ProcedureId: data.Id,
                    SubjectId: $("#panel-wrap").attr("data-sid")
                }                                           //请求参数
                //获取任务
                getAssignment("/TaskManagement/SubjectAssignment", __data, $(".ajax-procedure[data-procedureid=" + __data.ProcedureId + "]").find(".tm_panel-body"), function (data) {
                    dragtask("tm-list-show-" + __data.ProcedureId) //为任务注册拖动事件
                }, function (data) {
                    //失败
                })            
                $('#Edit-Assignment').modal('hide');
            }, function (data) {
                //失败
            })
        })
    });
</script>

